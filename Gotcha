-- ç‰©é«”é¸å–å™¨è…³æœ¬ (å¹³æ¿è§¸æ§ç‰ˆ)
-- åŠŸèƒ½ï¼šè§¸æ§é¸å–ç‰©é«”é¡¯ç¤ºç¶ è‰²å¤–æ¡†ã€è·¯å¾‘é¡¯ç¤ºã€è·¯å¾‘éæ¿¾ã€å‚³é€åŠŸèƒ½

local ObjectSelector = {}

-- é¸å–ç‹€æ…‹
ObjectSelector.selectedObjects = {} -- ç¶ è‰²å¤–æ¡†çš„ç‰©é«”ï¼ˆç›´æ¥é»æ“Šï¼‰
ObjectSelector.pathFilteredObjects = {} -- ç™½è‰²å¤–æ¡†çš„ç‰©é«”ï¼ˆè·¯å¾‘éæ¿¾ï¼‰
ObjectSelector.allSelectedObjects = {} -- æ‰€æœ‰é¸å–çš„ç‰©é«”ï¼ˆç¶ +ç™½ï¼‰
ObjectSelector.isSelectionMode = false -- ä¸€é–‹å§‹é—œé–‰é¸å–æ¨¡å¼
ObjectSelector.currentTeleportIndex = 1 -- ç•¶å‰å‚³é€ç´¢å¼•
ObjectSelector.isTeleporting = false -- æ˜¯å¦æ­£åœ¨è‡ªå‹•å‚³é€

-- GUI è®Šæ•¸
ObjectSelector.guiVisible = false
ObjectSelector.screenGui = nil
ObjectSelector.mainFrame = nil
ObjectSelector.isDragging = false
ObjectSelector.dragStart = nil
ObjectSelector.startPos = nil

-- æœå‹™
local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")

-- æœ¬åœ°ç©å®¶
local player = Players.LocalPlayer
local camera = workspace.CurrentCamera

-- åˆå§‹åŒ– GUI
function ObjectSelector:InitializeGUI()
    -- å‰µå»º ScreenGui
    self.screenGui = Instance.new("ScreenGui")
    self.screenGui.Name = "ObjectSelectorGUI"
    self.screenGui.ResetOnSpawn = false
    self.screenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    self.screenGui.Parent = player:WaitForChild("PlayerGui")
    
    -- ä¸»æ¡†æ¶ (é©ä¸­çš„å°ºå¯¸)
    self.mainFrame = Instance.new("Frame")
    self.mainFrame.Name = "MainFrame"
    self.mainFrame.Size = UDim2.new(0, 380, 0, 550)
    self.mainFrame.Position = UDim2.new(0.5, -190, 0.5, -275)
    self.mainFrame.BackgroundColor3 = Color3.fromRGB(35, 35, 35)
    self.mainFrame.BorderSizePixel = 3
    self.mainFrame.BorderColor3 = Color3.fromRGB(0, 255, 0)
    self.mainFrame.Active = true
    self.mainFrame.Draggable = false -- æˆ‘å€‘æœƒè‡ªå·±è™•ç†æ‹–å‹•
    self.mainFrame.Parent = self.screenGui
    
    -- åœ“è§’
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 12)
    corner.Parent = self.mainFrame
    
    -- æ¨™é¡Œæ¬„ (å¯æ‹–å‹•å€åŸŸ)
    local titleBar = Instance.new("Frame")
    titleBar.Name = "TitleBar"
    titleBar.Size = UDim2.new(1, 0, 0, 45)
    titleBar.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
    titleBar.BorderSizePixel = 0
    titleBar.Parent = self.mainFrame
    
    local titleBarCorner = Instance.new("UICorner")
    titleBarCorner.CornerRadius = UDim.new(0, 12)
    titleBarCorner.Parent = titleBar
    
    -- æ¨™é¡Œæ–‡å­—
    local title = Instance.new("TextLabel")
    title.Name = "Title"
    title.Size = UDim2.new(1, -100, 1, 0)
    title.Position = UDim2.new(0, 10, 0, 0)
    title.BackgroundTransparency = 1
    title.Text = "ğŸ¯ ç‰©é«”é¸å–å™¨"
    title.TextColor3 = Color3.fromRGB(0, 255, 0)
    title.TextSize = 20
    title.Font = Enum.Font.SourceSansBold
    title.TextXAlignment = Enum.TextXAlignment.Left
    title.Parent = titleBar
    
    -- æ·»åŠ æ‹–å‹•åŠŸèƒ½
    self:MakeDraggable(titleBar)
    
    -- é—œé–‰æŒ‰éˆ•
    local closeButton = Instance.new("TextButton")
    closeButton.Name = "CloseButton"
    closeButton.Size = UDim2.new(0, 38, 0, 38)
    closeButton.Position = UDim2.new(1, -42, 0, 4)
    closeButton.BackgroundColor3 = Color3.fromRGB(220, 50, 50)
    closeButton.Text = "âœ•"
    closeButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    closeButton.TextSize = 22
    closeButton.Font = Enum.Font.SourceSansBold
    closeButton.Parent = titleBar
    
    local closeCorner = Instance.new("UICorner")
    closeCorner.CornerRadius = UDim.new(0, 8)
    closeCorner.Parent = closeButton
    
    closeButton.MouseButton1Click:Connect(function()
        self.guiVisible = false
        self.mainFrame.Visible = false
    end)
    
    -- é¸å–æ¨¡å¼åˆ‡æ›æŒ‰éˆ•
    local toggleButton = Instance.new("TextButton")
    toggleButton.Name = "ToggleSelectionButton"
    toggleButton.Size = UDim2.new(0, 178, 0, 42)
    toggleButton.Position = UDim2.new(0, 10, 0, 55)
    toggleButton.BackgroundColor3 = Color3.fromRGB(200, 100, 0)
    toggleButton.Text = "â¸ é¸å–æ¨¡å¼ï¼šé—œé–‰"
    toggleButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    toggleButton.TextSize = 17
    toggleButton.Font = Enum.Font.SourceSansBold
    toggleButton.Parent = self.mainFrame
    
    local toggleCorner = Instance.new("UICorner")
    toggleCorner.CornerRadius = UDim.new(0, 8)
    toggleCorner.Parent = toggleButton
    
    toggleButton.MouseButton1Click:Connect(function()
        self.isSelectionMode = not self.isSelectionMode
        if self.isSelectionMode then
            toggleButton.Text = "âœ“ é¸å–æ¨¡å¼ï¼šé–‹å•Ÿ"
            toggleButton.BackgroundColor3 = Color3.fromRGB(0, 200, 0)
        else
            toggleButton.Text = "â¸ é¸å–æ¨¡å¼ï¼šé—œé–‰"
            toggleButton.BackgroundColor3 = Color3.fromRGB(200, 100, 0)
        end
    end)
    
    -- æ¸…é™¤é¸å–æŒ‰éˆ•
    local clearButton = Instance.new("TextButton")
    clearButton.Name = "ClearButton"
    clearButton.Size = UDim2.new(0, 178, 0, 42)
    clearButton.Position = UDim2.new(0, 192, 0, 55)
    clearButton.BackgroundColor3 = Color3.fromRGB(200, 0, 0)
    clearButton.Text = "ğŸ—‘ è§£é™¤æ‰€æœ‰é¸å–"
    clearButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    clearButton.TextSize = 17
    clearButton.Font = Enum.Font.SourceSansBold
    clearButton.Parent = self.mainFrame
    
    local clearCorner = Instance.new("UICorner")
    clearCorner.CornerRadius = UDim.new(0, 8)
    clearCorner.Parent = clearButton
    
    clearButton.MouseButton1Click:Connect(function()
        self:ClearAllSelections()
    end)
    
    -- è·¯å¾‘é¡¯ç¤ºæ¨™é¡Œ
    local pathLabel = Instance.new("TextLabel")
    pathLabel.Name = "PathLabel"
    pathLabel.Size = UDim2.new(1, -20, 0, 28)
    pathLabel.Position = UDim2.new(0, 10, 0, 107)
    pathLabel.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
    pathLabel.BorderSizePixel = 0
    pathLabel.Text = "ğŸ“‚ ç‰©é«”è·¯å¾‘ (é»æ“Šéæ¿¾)"
    pathLabel.TextColor3 = Color3.fromRGB(220, 220, 220)
    pathLabel.TextSize = 15
    pathLabel.Font = Enum.Font.SourceSansBold
    pathLabel.TextXAlignment = Enum.TextXAlignment.Left
    pathLabel.Parent = self.mainFrame
    
    local pathLabelCorner = Instance.new("UICorner")
    pathLabelCorner.CornerRadius = UDim.new(0, 6)
    pathLabelCorner.Parent = pathLabel
    
    -- è·¯å¾‘æ»¾å‹•æ¡†æ¶
    local pathScrollFrame = Instance.new("ScrollingFrame")
    pathScrollFrame.Name = "PathScrollFrame"
    pathScrollFrame.Size = UDim2.new(1, -20, 0, 90)
    pathScrollFrame.Position = UDim2.new(0, 10, 0, 142)
    pathScrollFrame.BackgroundColor3 = Color3.fromRGB(45, 45, 45)
    pathScrollFrame.BorderSizePixel = 2
    pathScrollFrame.BorderColor3 = Color3.fromRGB(80, 80, 80)
    pathScrollFrame.ScrollBarThickness = 10
    pathScrollFrame.Parent = self.mainFrame
    
    local pathScrollCorner = Instance.new("UICorner")
    pathScrollCorner.CornerRadius = UDim.new(0, 8)
    pathScrollCorner.Parent = pathScrollFrame
    
    -- åˆ—è¡¨å¸ƒå±€
    local pathLayout = Instance.new("UIListLayout")
    pathLayout.Name = "PathLayout"
    pathLayout.SortOrder = Enum.SortOrder.LayoutOrder
    pathLayout.Padding = UDim.new(0, 3)
    pathLayout.Parent = pathScrollFrame
    
    -- å‚³é€åˆ°ç‰©é«”æŒ‰éˆ•
    local teleportToButton = Instance.new("TextButton")
    teleportToButton.Name = "TeleportToButton"
    teleportToButton.Size = UDim2.new(1, -20, 0, 48)
    teleportToButton.Position = UDim2.new(0, 10, 0, 242)
    teleportToButton.BackgroundColor3 = Color3.fromRGB(0, 150, 255)
    teleportToButton.Text = "ğŸš€ å‚³é€åˆ°ç‰©é«” (1/0)"
    teleportToButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    teleportToButton.TextSize = 19
    teleportToButton.Font = Enum.Font.SourceSansBold
    teleportToButton.Parent = self.mainFrame
    
    local teleportToCorner = Instance.new("UICorner")
    teleportToCorner.CornerRadius = UDim.new(0, 8)
    teleportToCorner.Parent = teleportToButton
    
    teleportToButton.MouseButton1Click:Connect(function()
        self:TeleportToObject()
    end)
    
    -- å‚³é€ç‰©é«”åˆ°ç©å®¶æŒ‰éˆ•
    local teleportHereButton = Instance.new("TextButton")
    teleportHereButton.Name = "TeleportHereButton"
    teleportHereButton.Size = UDim2.new(1, -20, 0, 48)
    teleportHereButton.Position = UDim2.new(0, 10, 0, 298)
    teleportHereButton.BackgroundColor3 = Color3.fromRGB(255, 150, 0)
    teleportHereButton.Text = "ğŸ“¦ å‚³é€ç‰©é«”åˆ°æˆ‘ (0)"
    teleportHereButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    teleportHereButton.TextSize = 19
    teleportHereButton.Font = Enum.Font.SourceSansBold
    teleportHereButton.Parent = self.mainFrame
    
    local teleportHereCorner = Instance.new("UICorner")
    teleportHereCorner.CornerRadius = UDim.new(0, 8)
    teleportHereCorner.Parent = teleportHereButton
    
    teleportHereButton.MouseButton1Click:Connect(function()
        self:TeleportObjectsHere()
    end)
    
    -- é¸å–åˆ—è¡¨æ¨™é¡Œ
    local listLabel = Instance.new("TextLabel")
    listLabel.Name = "ListLabel"
    listLabel.Size = UDim2.new(1, -20, 0, 28)
    listLabel.Position = UDim2.new(0, 10, 0, 356)
    listLabel.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
    listLabel.BorderSizePixel = 0
    listLabel.Text = "ğŸ“‹ å·²é¸å–çš„ç‰©é«”"
    listLabel.TextColor3 = Color3.fromRGB(220, 220, 220)
    listLabel.TextSize = 15
    listLabel.Font = Enum.Font.SourceSansBold
    listLabel.TextXAlignment = Enum.TextXAlignment.Left
    listLabel.Parent = self.mainFrame
    
    local listLabelCorner = Instance.new("UICorner")
    listLabelCorner.CornerRadius = UDim.new(0, 6)
    listLabelCorner.Parent = listLabel
    
    -- é¸å–åˆ—è¡¨æ»¾å‹•æ¡†æ¶
    local listScrollFrame = Instance.new("ScrollingFrame")
    listScrollFrame.Name = "ListScrollFrame"
    listScrollFrame.Size = UDim2.new(1, -20, 0, 155)
    listScrollFrame.Position = UDim2.new(0, 10, 0, 391)
    listScrollFrame.BackgroundColor3 = Color3.fromRGB(45, 45, 45)
    listScrollFrame.BorderSizePixel = 2
    listScrollFrame.BorderColor3 = Color3.fromRGB(80, 80, 80)
    listScrollFrame.ScrollBarThickness = 10
    listScrollFrame.Parent = self.mainFrame
    
    local listScrollCorner = Instance.new("UICorner")
    listScrollCorner.CornerRadius = UDim.new(0, 8)
    listScrollCorner.Parent = listScrollFrame
    
    -- åˆ—è¡¨å¸ƒå±€
    local listLayout = Instance.new("UIListLayout")
    listLayout.Name = "ListLayout"
    listLayout.SortOrder = Enum.SortOrder.LayoutOrder
    listLayout.Padding = UDim.new(0, 3)
    listLayout.Parent = listScrollFrame
    
    self.mainFrame.Visible = false
end

-- ä½¿æ¡†æ¶å¯æ‹–å‹•
function ObjectSelector:MakeDraggable(frame)
    local dragging = false
    local dragInput
    local dragStart
    local startPos

    local function update(input)
        if dragging then
            local delta = input.Position - dragStart
            self.mainFrame.Position = UDim2.new(
                startPos.X.Scale,
                startPos.X.Offset + delta.X,
                startPos.Y.Scale,
                startPos.Y.Offset + delta.Y
            )
        end
    end

    frame.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or 
           input.UserInputType == Enum.UserInputType.Touch then
            dragging = true
            dragStart = input.Position
            startPos = self.mainFrame.Position

            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragging = false
                end
            end)
        end
    end)

    frame.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement or 
           input.UserInputType == Enum.UserInputType.Touch then
            dragInput = input
        end
    end)

    UserInputService.InputChanged:Connect(function(input)
        if input == dragInput and dragging then
            update(input)
        end
    end)
end

-- ç²å–ç‰©é«”å®Œæ•´è·¯å¾‘
function ObjectSelector:GetObjectPath(obj)
    local path = {}
    local current = obj
    while current and current ~= game do
        table.insert(path, 1, current.Name)
        current = current.Parent
    end
    return path
end

-- ç²å–è·¯å¾‘å­—ç¬¦ä¸²
function ObjectSelector:GetPathString(pathTable)
    return table.concat(pathTable, " > ")
end

-- æ·»åŠ é«˜äº®æ¡†
function ObjectSelector:AddHighlight(obj, color)
    if not obj:IsA("BasePart") and not obj:IsA("Model") then return end
    
    -- ç§»é™¤èˆŠçš„é«˜äº®
    local oldHighlight = obj:FindFirstChild("SelectorHighlight")
    if oldHighlight then
        oldHighlight:Destroy()
    end
    
    -- å‰µå»ºæ–°é«˜äº®
    local highlight = Instance.new("SelectionBox")
    highlight.Name = "SelectorHighlight"
    highlight.Adornee = obj
    highlight.Color3 = color
    highlight.LineThickness = 0.05
    highlight.SurfaceTransparency = 0.9
    highlight.Parent = obj
end

-- ç§»é™¤é«˜äº®æ¡†
function ObjectSelector:RemoveHighlight(obj)
    local highlight = obj:FindFirstChild("SelectorHighlight")
    if highlight then
        highlight:Destroy()
    end
end

-- é¸å–ç‰©é«”
function ObjectSelector:SelectObject(obj)
    if not obj then return end
    
    -- æª¢æŸ¥æ˜¯å¦å·²ç¶“é¸å–
    for _, selected in ipairs(self.selectedObjects) do
        if selected == obj then
            return
        end
    end
    
    -- æ·»åŠ åˆ°é¸å–åˆ—è¡¨
    table.insert(self.selectedObjects, obj)
    self:AddHighlight(obj, Color3.fromRGB(0, 255, 0)) -- ç¶ è‰²å¤–æ¡†
    
    -- æ›´æ–°æ‰€æœ‰é¸å–ç‰©é«”åˆ—è¡¨
    self:UpdateAllSelectedObjects()
    self:UpdateGUI()
    self:UpdatePathDisplay(obj)
end

-- è·¯å¾‘éæ¿¾é¸å–
function ObjectSelector:FilterByPath(pathIndex, clickedObj)
    -- æ¸…é™¤ä¹‹å‰çš„è·¯å¾‘éæ¿¾
    for _, obj in ipairs(self.pathFilteredObjects) do
        self:RemoveHighlight(obj)
    end
    self.pathFilteredObjects = {}
    
    local clickedPath = self:GetObjectPath(clickedObj)
    local filterPath = {}
    for i = 1, pathIndex do
        table.insert(filterPath, clickedPath[i])
    end
    
    -- å–å¾—é»æ“Šç‰©é«”çš„åç¨±ï¼ˆç”¨æ–¼åŒåæœå°‹ï¼‰
    local targetName = clickedObj.Name
    
    -- éæ­· workspace æ‰¾åˆ°ç¬¦åˆè·¯å¾‘å‰ç¶´çš„ç‰©é«”
    local function searchDescendants(parent, currentDepth)
        if currentDepth > #filterPath then return end
        
        for _, child in ipairs(parent:GetChildren()) do
            local childPath = self:GetObjectPath(child)
            
            -- æª¢æŸ¥è·¯å¾‘å‰ç¶´æ˜¯å¦åŒ¹é…
            local matches = true
            for i = 1, #filterPath do
                if childPath[i] ~= filterPath[i] then
                    matches = false
                    break
                end
            end
            
            -- æª¢æŸ¥å¾ŒçºŒè·¯å¾‘æ˜¯å¦ä¸åŒ æˆ– åŒåç‰©ä»¶
            if matches and #childPath > #filterPath then
                local isDifferent = false
                local isSameName = (child.Name == targetName)
                
                if #childPath > #clickedPath then
                    isDifferent = true
                else
                    for i = #filterPath + 1, #childPath do
                        if childPath[i] ~= clickedPath[i] then
                            isDifferent = true
                            break
                        end
                    end
                end
                
                -- å¦‚æœè·¯å¾‘ä¸åŒæˆ–æ˜¯åŒåç‰©ä»¶ï¼Œå°±åŠ å…¥
                if (isDifferent or isSameName) and child ~= clickedObj then
                    -- æª¢æŸ¥æ˜¯å¦å·²åœ¨ç¶ è‰²é¸å–ä¸­
                    local isGreenSelected = false
                    for _, selected in ipairs(self.selectedObjects) do
                        if selected == child then
                            isGreenSelected = true
                            break
                        end
                    end
                    
                    if not isGreenSelected then
                        table.insert(self.pathFilteredObjects, child)
                        self:AddHighlight(child, Color3.fromRGB(255, 255, 255)) -- ç™½è‰²å¤–æ¡†
                    end
                end
            end
            
            searchDescendants(child, currentDepth + 1)
        end
    end
    
    searchDescendants(game.Workspace, 1)
    
    -- æ›´æ–°æ‰€æœ‰é¸å–ç‰©é«”åˆ—è¡¨
    self:UpdateAllSelectedObjects()
    self:UpdateGUI()
end

-- æ›´æ–°æ‰€æœ‰é¸å–ç‰©é«”åˆ—è¡¨
function ObjectSelector:UpdateAllSelectedObjects()
    self.allSelectedObjects = {}
    
    -- æ·»åŠ ç¶ è‰²é¸å–çš„ç‰©é«”
    for _, obj in ipairs(self.selectedObjects) do
        table.insert(self.allSelectedObjects, obj)
    end
    
    -- æ·»åŠ ç™½è‰²é¸å–çš„ç‰©é«”
    for _, obj in ipairs(self.pathFilteredObjects) do
        table.insert(self.allSelectedObjects, obj)
    end
end

-- æ›´æ–°è·¯å¾‘é¡¯ç¤º
function ObjectSelector:UpdatePathDisplay(obj)
    local pathScrollFrame = self.mainFrame:FindFirstChild("PathScrollFrame")
    if not pathScrollFrame then return end
    
    -- æ¸…é™¤èˆŠè·¯å¾‘
    for _, child in ipairs(pathScrollFrame:GetChildren()) do
        if child:IsA("TextButton") then
            child:Destroy()
        end
    end
    
    local path = self:GetObjectPath(obj)
    
    -- å‰µå»ºè·¯å¾‘æŒ‰éˆ•
    for i, name in ipairs(path) do
        local pathButton = Instance.new("TextButton")
        pathButton.Name = "PathButton_" .. i
        pathButton.Size = UDim2.new(1, -12, 0, 28)
        pathButton.BackgroundColor3 = Color3.fromRGB(65, 65, 65)
        pathButton.BorderSizePixel = 0
        pathButton.Text = string.rep("  ", i - 1) .. "â–¸ " .. name
        pathButton.TextColor3 = Color3.fromRGB(255, 255, 255)
        pathButton.TextSize = 15
        pathButton.Font = Enum.Font.SourceSans
        pathButton.TextXAlignment = Enum.TextXAlignment.Left
        pathButton.LayoutOrder = i
        pathButton.Parent = pathScrollFrame
        
        local buttonCorner = Instance.new("UICorner")
        buttonCorner.CornerRadius = UDim.new(0, 6)
        buttonCorner.Parent = pathButton
        
        -- é»æ“Šè·¯å¾‘éæ¿¾
        pathButton.MouseButton1Click:Connect(function()
            self:FilterByPath(i, obj)
            -- è¦–è¦ºåé¥‹
            pathButton.BackgroundColor3 = Color3.fromRGB(0, 150, 255)
            wait(0.2)
            pathButton.BackgroundColor3 = Color3.fromRGB(65, 65, 65)
        end)
        
        -- æ‡¸åœæ•ˆæœ
        pathButton.MouseEnter:Connect(function()
            pathButton.BackgroundColor3 = Color3.fromRGB(90, 90, 90)
        end)
        
        pathButton.MouseLeave:Connect(function()
            pathButton.BackgroundColor3 = Color3.fromRGB(65, 65, 65)
        end)
    end
    
    -- æ›´æ–°æ»¾å‹•æ¡†æ¶å¤§å°
    pathScrollFrame.CanvasSize = UDim2.new(0, 0, 0, #path * 31)
end

-- æ›´æ–° GUI
function ObjectSelector:UpdateGUI()
    local teleportToButton = self.mainFrame:FindFirstChild("TeleportToButton")
    local teleportHereButton = self.mainFrame:FindFirstChild("TeleportHereButton")
    local listScrollFrame = self.mainFrame:FindFirstChild("ListScrollFrame")
    
    if teleportToButton then
        local count = #self.allSelectedObjects
        if self.isTeleporting then
            teleportToButton.Text = string.format("â¸ åœæ­¢è‡ªå‹•å‚³é€ (%d/%d)", self.currentTeleportIndex, count)
            teleportToButton.BackgroundColor3 = Color3.fromRGB(200, 100, 0)
        else
            teleportToButton.Text = string.format("ğŸš€ å‚³é€åˆ°ç‰©é«” (%d)", count)
            teleportToButton.BackgroundColor3 = Color3.fromRGB(0, 150, 255)
        end
    end
    
    if teleportHereButton then
        teleportHereButton.Text = string.format("ğŸ“¦ å‚³é€ç‰©é«”åˆ°æˆ‘ (%d)", #self.allSelectedObjects)
    end
    
    -- æ›´æ–°é¸å–åˆ—è¡¨ (æ›´å¤§çš„é …ç›®)
    if listScrollFrame then
        for _, child in ipairs(listScrollFrame:GetChildren()) do
            if child:IsA("TextLabel") then
                child:Destroy()
            end
        end
        
        for i, obj in ipairs(self.allSelectedObjects) do
            local isGreen = false
            for _, selected in ipairs(self.selectedObjects) do
                if selected == obj then
                    isGreen = true
                    break
                end
            end
            
            local itemLabel = Instance.new("TextLabel")
            itemLabel.Name = "Item_" .. i
            itemLabel.Size = UDim2.new(1, -12, 0, 28)
            itemLabel.BackgroundColor3 = isGreen and Color3.fromRGB(0, 120, 0) or Color3.fromRGB(70, 70, 70)
            itemLabel.BorderSizePixel = 0
            itemLabel.Text = (isGreen and "ğŸŸ¢ " or "â¬œ ") .. obj.Name
            itemLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
            itemLabel.TextSize = 15
            itemLabel.Font = Enum.Font.SourceSans
            itemLabel.TextXAlignment = Enum.TextXAlignment.Left
            itemLabel.LayoutOrder = i
            itemLabel.Parent = listScrollFrame
            
            local itemCorner = Instance.new("UICorner")
            itemCorner.CornerRadius = UDim.new(0, 6)
            itemCorner.Parent = itemLabel
        end
        
        listScrollFrame.CanvasSize = UDim2.new(0, 0, 0, #self.allSelectedObjects * 31)
    end
end

-- å‚³é€åˆ°ç‰©é«”ï¼ˆè‡ªå‹•è¼ªæµï¼‰
function ObjectSelector:TeleportToObject()
    if #self.allSelectedObjects == 0 then return end
    
    local character = player.Character
    if not character then return end
    
    local humanoidRootPart = character:FindFirstChild("HumanoidRootPart")
    if not humanoidRootPart then return end
    
    -- é–‹å§‹è‡ªå‹•è¼ªæµå‚³é€
    if not self.isTeleporting then
        self.isTeleporting = true
        self.currentTeleportIndex = 1
        
        -- å‰µå»ºå¾ªç’°å‚³é€
        spawn(function()
            while self.isTeleporting and #self.allSelectedObjects > 0 do
                -- å¾ªç’°ç´¢å¼•
                if self.currentTeleportIndex > #self.allSelectedObjects then
                    self.currentTeleportIndex = 1
                end
                
                local targetObj = self.allSelectedObjects[self.currentTeleportIndex]
                if targetObj then
                    local targetPos
                    if targetObj:IsA("BasePart") then
                        targetPos = targetObj.Position + Vector3.new(0, 5, 0)
                    elseif targetObj:IsA("Model") then
                        local primaryPart = targetObj.PrimaryPart or targetObj:FindFirstChildWhichIsA("BasePart")
                        if primaryPart then
                            targetPos = primaryPart.Position + Vector3.new(0, 5, 0)
                        end
                    end
                    
                    if targetPos then
                        humanoidRootPart.CFrame = CFrame.new(targetPos)
                        self.currentTeleportIndex = self.currentTeleportIndex + 1
                        self:UpdateGUI()
                    end
                end
                
                wait(0.1) -- æ¯0.1ç§’å‚³é€åˆ°ä¸‹ä¸€å€‹ç‰©é«”
            end
            
            self.isTeleporting = false
            self:UpdateGUI()
        end)
        
        -- æ›´æ–°æŒ‰éˆ•æ–‡å­—
        local teleportToButton = self.mainFrame:FindFirstChild("TeleportToButton")
        if teleportToButton then
            teleportToButton.Text = "â¸ åœæ­¢è‡ªå‹•å‚³é€"
            teleportToButton.BackgroundColor3 = Color3.fromRGB(200, 100, 0)
        end
    else
        -- åœæ­¢è‡ªå‹•å‚³é€
        self.isTeleporting = false
        self.currentTeleportIndex = 1
        
        local teleportToButton = self.mainFrame:FindFirstChild("TeleportToButton")
        if teleportToButton then
            teleportToButton.Text = string.format("ğŸš€ å‚³é€åˆ°ç‰©é«” (1/%d)", #self.allSelectedObjects)
            teleportToButton.BackgroundColor3 = Color3.fromRGB(0, 150, 255)
        end
    end
end

-- å‚³é€ç‰©é«”åˆ°ç©å®¶ï¼ˆæ‰€æœ‰ç‰©é«”åˆ°åŒä¸€ä½ç½®ï¼‰
function ObjectSelector:TeleportObjectsHere()
    if #self.allSelectedObjects == 0 then return end
    
    local character = player.Character
    if not character then return end
    
    local humanoidRootPart = character:FindFirstChild("HumanoidRootPart")
    if not humanoidRootPart then return end
    
    local playerPos = humanoidRootPart.Position
    local targetPos = playerPos + Vector3.new(0, 2, 5) -- ç©å®¶å‰æ–¹
    
    -- å°‡æ‰€æœ‰é¸å–çš„ç‰©é«”å‚³é€åˆ°åŒä¸€ä½ç½®
    for _, obj in ipairs(self.allSelectedObjects) do
        if obj:IsA("BasePart") then
            obj.CFrame = CFrame.new(targetPos)
        elseif obj:IsA("Model") then
            local primaryPart = obj.PrimaryPart or obj:FindFirstChildWhichIsA("BasePart")
            if primaryPart then
                obj:MoveTo(targetPos)
            end
        end
    end
end

-- æ¸…é™¤æ‰€æœ‰é¸å–
function ObjectSelector:ClearAllSelections()
    -- æ¸…é™¤ç¶ è‰²é¸å–
    for _, obj in ipairs(self.selectedObjects) do
        self:RemoveHighlight(obj)
    end
    self.selectedObjects = {}
    
    -- æ¸…é™¤ç™½è‰²é¸å–
    for _, obj in ipairs(self.pathFilteredObjects) do
        self:RemoveHighlight(obj)
    end
    self.pathFilteredObjects = {}
    
    self.allSelectedObjects = {}
    self.currentTeleportIndex = 1
    
    self:UpdateGUI()
    
    -- æ¸…é™¤è·¯å¾‘é¡¯ç¤º
    local pathScrollFrame = self.mainFrame:FindFirstChild("PathScrollFrame")
    if pathScrollFrame then
        for _, child in ipairs(pathScrollFrame:GetChildren()) do
            if child:IsA("TextButton") then
                child:Destroy()
            end
        end
    end
end

-- è™•ç†è§¸æ§é¸å–
function ObjectSelector:HandleTouchSelection(input)
    if not self.isSelectionMode then return end
    
    -- å¾è§¸æ§ä½ç½®ç™¼å°„å°„ç·š
    local unitRay = camera:ScreenPointToRay(input.Position.X, input.Position.Y)
    local ray = Ray.new(unitRay.Origin, unitRay.Direction * 1000)
    
    -- é€²è¡Œå°„ç·šæª¢æ¸¬
    local target = workspace:FindPartOnRay(ray, player.Character)
    
    if target then
        self:SelectObject(target)
        
        -- é¡¯ç¤º GUI
        if not self.guiVisible then
            self.guiVisible = true
            self.mainFrame.Visible = true
        end
        
        -- è§¸è¦ºåé¥‹ï¼ˆå¦‚æœå¯ç”¨ï¼‰
        if game:GetService("HapticService"):IsVibrationSupported(Enum.UserInputType.Gamepad1) then
            game:GetService("HapticService"):SetMotor(Enum.UserInputType.Gamepad1, Enum.VibrationMotor.Large, 0.5)
            wait(0.1)
            game:GetService("HapticService"):SetMotor(Enum.UserInputType.Gamepad1, Enum.VibrationMotor.Large, 0)
        end
    end
end

-- åˆå§‹åŒ–
function ObjectSelector:Initialize()
    self:InitializeGUI()
    
    -- å‰µå»ºé–‹å•ŸæŒ‰éˆ•ï¼ˆå›ºå®šåœ¨è¢å¹•è§’è½ï¼‰
    local openButton = Instance.new("TextButton")
    openButton.Name = "OpenButton"
    openButton.Size = UDim2.new(0, 60, 0, 60)
    openButton.Position = UDim2.new(1, -70, 0, 10)
    openButton.BackgroundColor3 = Color3.fromRGB(0, 200, 0)
    openButton.Text = "ğŸ¯"
    openButton.TextSize = 32
    openButton.Font = Enum.Font.SourceSansBold
    openButton.ZIndex = 10
    openButton.Parent = self.screenGui
    
    local openCorner = Instance.new("UICorner")
    openCorner.CornerRadius = UDim.new(0, 12)
    openCorner.Parent = openButton
    
    -- æ·»åŠ é™°å½±æ•ˆæœ
    local openShadow = Instance.new("ImageLabel")
    openShadow.Name = "Shadow"
    openShadow.Size = UDim2.new(1, 10, 1, 10)
    openShadow.Position = UDim2.new(0, -5, 0, -5)
    openShadow.BackgroundTransparency = 1
    openShadow.Image = "rbxasset://textures/ui/GuiImagePlaceholder.png"
    openShadow.ImageTransparency = 0.7
    openShadow.ZIndex = 9
    openShadow.Parent = openButton
    
    openButton.MouseButton1Click:Connect(function()
        self.guiVisible = not self.guiVisible
        self.mainFrame.Visible = self.guiVisible
        
        -- æŒ‰éˆ•å‹•ç•«
        openButton:TweenSize(UDim2.new(0, 54, 0, 54), "Out", "Quad", 0.1, true, function()
            openButton:TweenSize(UDim2.new(0, 60, 0, 60), "Out", "Quad", 0.1, true)
        end)
    end)
    
    -- è§¸æ§è¼¸å…¥è™•ç†
    UserInputService.InputBegan:Connect(function(input, gameProcessed)
        -- å¦‚æœè¼¸å…¥è¢«GUIè™•ç†ï¼Œå‰‡å¿½ç•¥
        if gameProcessed then return end
        
        -- è™•ç†è§¸æ§å’Œæ»‘é¼ é»æ“Š
        if input.UserInputType == Enum.UserInputType.Touch or 
           input.UserInputType == Enum.UserInputType.MouseButton1 then
            -- å»¶é²ä¸€é»ç¢ºä¿ä¸æ˜¯åœ¨æ‹–å‹•GUI
            wait(0.05)
            if not self.isDragging then
                self:HandleTouchSelection(input)
            end
        end
    end)
    
    print("ğŸ¯ ç‰©é«”é¸å–å™¨å·²å•Ÿå‹•ï¼(å¹³æ¿è§¸æ§ç‰ˆ)")
    print("ğŸ“± é»æ“Šå³ä¸Šè§’ç¶ è‰²æŒ‰éˆ•é–‹å•Ÿç•Œé¢")
    print("ğŸ‘† è§¸æ§ç‰©é«”é€²è¡Œé¸å–ï¼ˆç¶ è‰²å¤–æ¡†ï¼‰")
    print("ğŸ“‚ é»æ“Šè·¯å¾‘å¯éæ¿¾ç›¸ä¼¼ç‰©é«”ï¼ˆç™½è‰²å¤–æ¡†ï¼‰")
    print("ğŸš€ å¯æ‹–å‹•ç•Œé¢ç§»å‹•ä½ç½®")
end

-- å•Ÿå‹•è…³æœ¬
ObjectSelector:Initialize()

return ObjectSelector
