-- ç‰©é«”é¸å–å™¨è…³æœ¬ (å¹³æ¿è§¸æ§ç‰ˆ)
-- åŠŸèƒ½ï¼šè§¸æ§é¸å–ç‰©é«”é¡¯ç¤ºç¶ è‰²å¤–æ¡†ã€è·¯å¾‘é¡¯ç¤ºã€è·¯å¾‘éæ¿¾ã€å‚³é€åŠŸèƒ½
-- æ›´æ–°ï¼šæ¯å€‹å·²é¸å–ç‰©ä»¶åˆ—è¡¨é …ç›®æ–°å¢ "+" æŒ‰éˆ•ï¼Œå¯å±•é–‹ã€Œå–®ç¨é¸å–ã€å’Œã€Œè§£é™¤é¸å–ã€

local ObjectSelector = {}

-- é¸å–ç‹€æ…‹
ObjectSelector.selectedObjects = {}       -- ç¶ è‰²å¤–æ¡†çš„ç‰©é«”ï¼ˆç›´æ¥é»æ“Šï¼‰
ObjectSelector.pathFilteredObjects = {}   -- ç™½è‰²å¤–æ¡†çš„ç‰©é«”ï¼ˆè·¯å¾‘éæ¿¾ï¼‰
ObjectSelector.allSelectedObjects = {}    -- æ‰€æœ‰é¸å–çš„ç‰©é«”ï¼ˆç¶ +ç™½ï¼‰
ObjectSelector.soloObjects = {}           -- â˜… å–®ç¨é¸å–ç‹€æ…‹é›†åˆ {[obj]=true}
ObjectSelector.isSelectionMode = false
ObjectSelector.currentTeleportIndex = 1
ObjectSelector.isTeleporting = false

-- GUI è®Šæ•¸
ObjectSelector.guiVisible = false
ObjectSelector.screenGui = nil
ObjectSelector.mainFrame = nil
ObjectSelector.isDragging = false
ObjectSelector.dragStart = nil
ObjectSelector.startPos = nil

-- æœå‹™
local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")

local player = Players.LocalPlayer
local camera = workspace.CurrentCamera

-- â˜… å–å¾—å¯¦éš›ä½œç”¨çš„ç‰©ä»¶ï¼ˆæœ‰å–®ç¨é¸å–å°±åªç”¨é‚£äº›ï¼Œå¦å‰‡å…¨éƒ¨ï¼‰
function ObjectSelector:GetActiveObjects()
    local hasSolo = false
    for _ in pairs(self.soloObjects) do hasSolo = true; break end
    if hasSolo then
        local list = {}
        for obj in pairs(self.soloObjects) do
            table.insert(list, obj)
        end
        return list
    end
    return self.allSelectedObjects
end

-- åˆå§‹åŒ– GUI
function ObjectSelector:InitializeGUI()
    self.screenGui = Instance.new("ScreenGui")
    self.screenGui.Name = "ObjectSelectorGUI"
    self.screenGui.ResetOnSpawn = false
    self.screenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    self.screenGui.Parent = player:WaitForChild("PlayerGui")

    self.mainFrame = Instance.new("Frame")
    self.mainFrame.Name = "MainFrame"
    self.mainFrame.Size = UDim2.new(0, 380, 0, 550)
    self.mainFrame.Position = UDim2.new(0.5, -190, 0.5, -275)
    self.mainFrame.BackgroundColor3 = Color3.fromRGB(35, 35, 35)
    self.mainFrame.BorderSizePixel = 3
    self.mainFrame.BorderColor3 = Color3.fromRGB(0, 255, 0)
    self.mainFrame.Active = true
    self.mainFrame.Draggable = false
    self.mainFrame.Parent = self.screenGui

    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 12)
    corner.Parent = self.mainFrame

    -- æ¨™é¡Œæ¬„
    local titleBar = Instance.new("Frame")
    titleBar.Name = "TitleBar"
    titleBar.Size = UDim2.new(1, 0, 0, 45)
    titleBar.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
    titleBar.BorderSizePixel = 0
    titleBar.Parent = self.mainFrame

    local titleBarCorner = Instance.new("UICorner")
    titleBarCorner.CornerRadius = UDim.new(0, 12)
    titleBarCorner.Parent = titleBar

    local title = Instance.new("TextLabel")
    title.Name = "Title"
    title.Size = UDim2.new(1, -100, 1, 0)
    title.Position = UDim2.new(0, 10, 0, 0)
    title.BackgroundTransparency = 1
    title.Text = "ğŸ¯ ç‰©é«”é¸å–å™¨"
    title.TextColor3 = Color3.fromRGB(0, 255, 0)
    title.TextSize = 20
    title.Font = Enum.Font.SourceSansBold
    title.TextXAlignment = Enum.TextXAlignment.Left
    title.Parent = titleBar

    self:MakeDraggable(titleBar)

    local closeButton = Instance.new("TextButton")
    closeButton.Name = "CloseButton"
    closeButton.Size = UDim2.new(0, 38, 0, 38)
    closeButton.Position = UDim2.new(1, -42, 0, 4)
    closeButton.BackgroundColor3 = Color3.fromRGB(220, 50, 50)
    closeButton.Text = "âœ•"
    closeButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    closeButton.TextSize = 22
    closeButton.Font = Enum.Font.SourceSansBold
    closeButton.Parent = titleBar
    local closeCorner = Instance.new("UICorner")
    closeCorner.CornerRadius = UDim.new(0, 8)
    closeCorner.Parent = closeButton
    closeButton.MouseButton1Click:Connect(function()
        self.guiVisible = false
        self.mainFrame.Visible = false
    end)

    -- é¸å–æ¨¡å¼æŒ‰éˆ•
    local toggleButton = Instance.new("TextButton")
    toggleButton.Name = "ToggleSelectionButton"
    toggleButton.Size = UDim2.new(0, 178, 0, 42)
    toggleButton.Position = UDim2.new(0, 10, 0, 55)
    toggleButton.BackgroundColor3 = Color3.fromRGB(200, 100, 0)
    toggleButton.Text = "â¸ é¸å–æ¨¡å¼ï¼šé—œé–‰"
    toggleButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    toggleButton.TextSize = 17
    toggleButton.Font = Enum.Font.SourceSansBold
    toggleButton.Parent = self.mainFrame
    local toggleCorner = Instance.new("UICorner")
    toggleCorner.CornerRadius = UDim.new(0, 8)
    toggleCorner.Parent = toggleButton
    toggleButton.MouseButton1Click:Connect(function()
        self.isSelectionMode = not self.isSelectionMode
        if self.isSelectionMode then
            toggleButton.Text = "âœ“ é¸å–æ¨¡å¼ï¼šé–‹å•Ÿ"
            toggleButton.BackgroundColor3 = Color3.fromRGB(0, 200, 0)
        else
            toggleButton.Text = "â¸ é¸å–æ¨¡å¼ï¼šé—œé–‰"
            toggleButton.BackgroundColor3 = Color3.fromRGB(200, 100, 0)
        end
    end)

    -- æ¸…é™¤é¸å–æŒ‰éˆ•
    local clearButton = Instance.new("TextButton")
    clearButton.Name = "ClearButton"
    clearButton.Size = UDim2.new(0, 178, 0, 42)
    clearButton.Position = UDim2.new(0, 192, 0, 55)
    clearButton.BackgroundColor3 = Color3.fromRGB(200, 0, 0)
    clearButton.Text = "ğŸ—‘ è§£é™¤æ‰€æœ‰é¸å–"
    clearButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    clearButton.TextSize = 17
    clearButton.Font = Enum.Font.SourceSansBold
    clearButton.Parent = self.mainFrame
    local clearCorner = Instance.new("UICorner")
    clearCorner.CornerRadius = UDim.new(0, 8)
    clearCorner.Parent = clearButton
    clearButton.MouseButton1Click:Connect(function()
        self:ClearAllSelections()
    end)

    -- è·¯å¾‘é¡¯ç¤ºæ¨™é¡Œ
    local pathLabel = Instance.new("TextLabel")
    pathLabel.Name = "PathLabel"
    pathLabel.Size = UDim2.new(1, -20, 0, 28)
    pathLabel.Position = UDim2.new(0, 10, 0, 107)
    pathLabel.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
    pathLabel.BorderSizePixel = 0
    pathLabel.Text = "ğŸ“‚ ç‰©é«”è·¯å¾‘ (é»æ“Šéæ¿¾)"
    pathLabel.TextColor3 = Color3.fromRGB(220, 220, 220)
    pathLabel.TextSize = 15
    pathLabel.Font = Enum.Font.SourceSansBold
    pathLabel.TextXAlignment = Enum.TextXAlignment.Left
    pathLabel.Parent = self.mainFrame
    local pathLabelCorner = Instance.new("UICorner")
    pathLabelCorner.CornerRadius = UDim.new(0, 6)
    pathLabelCorner.Parent = pathLabel

    -- è·¯å¾‘æ»¾å‹•æ¡†æ¶
    local pathScrollFrame = Instance.new("ScrollingFrame")
    pathScrollFrame.Name = "PathScrollFrame"
    pathScrollFrame.Size = UDim2.new(1, -20, 0, 90)
    pathScrollFrame.Position = UDim2.new(0, 10, 0, 142)
    pathScrollFrame.BackgroundColor3 = Color3.fromRGB(45, 45, 45)
    pathScrollFrame.BorderSizePixel = 2
    pathScrollFrame.BorderColor3 = Color3.fromRGB(80, 80, 80)
    pathScrollFrame.ScrollBarThickness = 10
    pathScrollFrame.Parent = self.mainFrame
    local pathScrollCorner = Instance.new("UICorner")
    pathScrollCorner.CornerRadius = UDim.new(0, 8)
    pathScrollCorner.Parent = pathScrollFrame
    local pathLayout = Instance.new("UIListLayout")
    pathLayout.Name = "PathLayout"
    pathLayout.SortOrder = Enum.SortOrder.LayoutOrder
    pathLayout.Padding = UDim.new(0, 3)
    pathLayout.Parent = pathScrollFrame

    -- å‚³é€åˆ°ç‰©é«”æŒ‰éˆ•
    local teleportToButton = Instance.new("TextButton")
    teleportToButton.Name = "TeleportToButton"
    teleportToButton.Size = UDim2.new(1, -20, 0, 48)
    teleportToButton.Position = UDim2.new(0, 10, 0, 242)
    teleportToButton.BackgroundColor3 = Color3.fromRGB(0, 150, 255)
    teleportToButton.Text = "ğŸš€ å‚³é€åˆ°ç‰©é«” (1/0)"
    teleportToButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    teleportToButton.TextSize = 19
    teleportToButton.Font = Enum.Font.SourceSansBold
    teleportToButton.Parent = self.mainFrame
    local teleportToCorner = Instance.new("UICorner")
    teleportToCorner.CornerRadius = UDim.new(0, 8)
    teleportToCorner.Parent = teleportToButton
    teleportToButton.MouseButton1Click:Connect(function()
        self:TeleportToObject()
    end)

    -- å‚³é€ç‰©é«”åˆ°ç©å®¶æŒ‰éˆ•
    local teleportHereButton = Instance.new("TextButton")
    teleportHereButton.Name = "TeleportHereButton"
    teleportHereButton.Size = UDim2.new(1, -20, 0, 48)
    teleportHereButton.Position = UDim2.new(0, 10, 0, 298)
    teleportHereButton.BackgroundColor3 = Color3.fromRGB(255, 150, 0)
    teleportHereButton.Text = "ğŸ“¦ å‚³é€ç‰©é«”åˆ°æˆ‘ (0)"
    teleportHereButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    teleportHereButton.TextSize = 19
    teleportHereButton.Font = Enum.Font.SourceSansBold
    teleportHereButton.Parent = self.mainFrame
    local teleportHereCorner = Instance.new("UICorner")
    teleportHereCorner.CornerRadius = UDim.new(0, 8)
    teleportHereCorner.Parent = teleportHereButton
    teleportHereButton.MouseButton1Click:Connect(function()
        self:TeleportObjectsHere()
    end)

    -- é¸å–åˆ—è¡¨æ¨™é¡Œ
    local listLabel = Instance.new("TextLabel")
    listLabel.Name = "ListLabel"
    listLabel.Size = UDim2.new(1, -20, 0, 28)
    listLabel.Position = UDim2.new(0, 10, 0, 356)
    listLabel.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
    listLabel.BorderSizePixel = 0
    listLabel.Text = "ğŸ“‹ å·²é¸å–çš„ç‰©é«”"
    listLabel.TextColor3 = Color3.fromRGB(220, 220, 220)
    listLabel.TextSize = 15
    listLabel.Font = Enum.Font.SourceSansBold
    listLabel.TextXAlignment = Enum.TextXAlignment.Left
    listLabel.Parent = self.mainFrame
    local listLabelCorner = Instance.new("UICorner")
    listLabelCorner.CornerRadius = UDim.new(0, 6)
    listLabelCorner.Parent = listLabel

    -- é¸å–åˆ—è¡¨æ»¾å‹•æ¡†æ¶
    local listScrollFrame = Instance.new("ScrollingFrame")
    listScrollFrame.Name = "ListScrollFrame"
    listScrollFrame.Size = UDim2.new(1, -20, 0, 155)
    listScrollFrame.Position = UDim2.new(0, 10, 0, 391)
    listScrollFrame.BackgroundColor3 = Color3.fromRGB(45, 45, 45)
    listScrollFrame.BorderSizePixel = 2
    listScrollFrame.BorderColor3 = Color3.fromRGB(80, 80, 80)
    listScrollFrame.ScrollBarThickness = 10
    listScrollFrame.Parent = self.mainFrame
    local listScrollCorner = Instance.new("UICorner")
    listScrollCorner.CornerRadius = UDim.new(0, 8)
    listScrollCorner.Parent = listScrollFrame
    local listLayout = Instance.new("UIListLayout")
    listLayout.Name = "ListLayout"
    listLayout.SortOrder = Enum.SortOrder.LayoutOrder
    listLayout.Padding = UDim.new(0, 3)
    listLayout.Parent = listScrollFrame

    self.mainFrame.Visible = false
end

-- ä½¿æ¡†æ¶å¯æ‹–å‹•
function ObjectSelector:MakeDraggable(frame)
    local dragging = false
    local dragInput
    local dragStart
    local startPos

    local function update(input)
        if dragging then
            local delta = input.Position - dragStart
            self.mainFrame.Position = UDim2.new(
                startPos.X.Scale, startPos.X.Offset + delta.X,
                startPos.Y.Scale, startPos.Y.Offset + delta.Y
            )
        end
    end

    frame.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or
           input.UserInputType == Enum.UserInputType.Touch then
            dragging = true
            dragStart = input.Position
            startPos = self.mainFrame.Position
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragging = false
                end
            end)
        end
    end)
    frame.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement or
           input.UserInputType == Enum.UserInputType.Touch then
            dragInput = input
        end
    end)
    UserInputService.InputChanged:Connect(function(input)
        if input == dragInput and dragging then update(input) end
    end)
end

function ObjectSelector:GetObjectPath(obj)
    local path = {}
    local current = obj
    while current and current ~= game do
        table.insert(path, 1, current.Name)
        current = current.Parent
    end
    return path
end

function ObjectSelector:GetPathString(pathTable)
    return table.concat(pathTable, " > ")
end

function ObjectSelector:AddHighlight(obj, color)
    if not obj:IsA("BasePart") and not obj:IsA("Model") then return end
    local oldHighlight = obj:FindFirstChild("SelectorHighlight")
    if oldHighlight then oldHighlight:Destroy() end
    local highlight = Instance.new("SelectionBox")
    highlight.Name = "SelectorHighlight"
    highlight.Adornee = obj
    highlight.Color3 = color
    highlight.LineThickness = 0.05
    highlight.SurfaceTransparency = 0.9
    highlight.Parent = obj
end

function ObjectSelector:RemoveHighlight(obj)
    local highlight = obj:FindFirstChild("SelectorHighlight")
    if highlight then highlight:Destroy() end
end

function ObjectSelector:SelectObject(obj)
    if not obj then return end
    for _, selected in ipairs(self.selectedObjects) do
        if selected == obj then return end
    end
    table.insert(self.selectedObjects, obj)
    self:AddHighlight(obj, Color3.fromRGB(0, 255, 0))
    self:UpdateAllSelectedObjects()
    self:UpdateGUI()
    self:UpdatePathDisplay(obj)
end

function ObjectSelector:FilterByPath(pathIndex, clickedObj)
    for _, obj in ipairs(self.pathFilteredObjects) do
        self:RemoveHighlight(obj)
    end
    self.pathFilteredObjects = {}
    local clickedPath = self:GetObjectPath(clickedObj)
    local filterPath = {}
    for i = 1, pathIndex do table.insert(filterPath, clickedPath[i]) end
    local targetName = clickedObj.Name
    local function searchDescendants(parent, currentDepth)
        if currentDepth > #filterPath then return end
        for _, child in ipairs(parent:GetChildren()) do
            local childPath = self:GetObjectPath(child)
            local matches = true
            for i = 1, #filterPath do
                if childPath[i] ~= filterPath[i] then matches = false; break end
            end
            if matches and #childPath > #filterPath then
                local isDifferent = false
                local isSameName = (child.Name == targetName)
                if #childPath > #clickedPath then
                    isDifferent = true
                else
                    for i = #filterPath + 1, #childPath do
                        if childPath[i] ~= clickedPath[i] then isDifferent = true; break end
                    end
                end
                if (isDifferent or isSameName) and child ~= clickedObj then
                    local isGreenSelected = false
                    for _, selected in ipairs(self.selectedObjects) do
                        if selected == child then isGreenSelected = true; break end
                    end
                    if not isGreenSelected then
                        table.insert(self.pathFilteredObjects, child)
                        self:AddHighlight(child, Color3.fromRGB(255, 255, 255))
                    end
                end
            end
            searchDescendants(child, currentDepth + 1)
        end
    end
    searchDescendants(game.Workspace, 1)
    self:UpdateAllSelectedObjects()
    self:UpdateGUI()
end

function ObjectSelector:UpdateAllSelectedObjects()
    self.allSelectedObjects = {}
    for _, obj in ipairs(self.selectedObjects) do
        table.insert(self.allSelectedObjects, obj)
    end
    for _, obj in ipairs(self.pathFilteredObjects) do
        table.insert(self.allSelectedObjects, obj)
    end
end

function ObjectSelector:UpdatePathDisplay(obj)
    local pathScrollFrame = self.mainFrame:FindFirstChild("PathScrollFrame")
    if not pathScrollFrame then return end
    for _, child in ipairs(pathScrollFrame:GetChildren()) do
        if child:IsA("TextButton") then child:Destroy() end
    end
    local path = self:GetObjectPath(obj)
    for i, name in ipairs(path) do
        local pathButton = Instance.new("TextButton")
        pathButton.Name = "PathButton_" .. i
        pathButton.Size = UDim2.new(1, -12, 0, 28)
        pathButton.BackgroundColor3 = Color3.fromRGB(65, 65, 65)
        pathButton.BorderSizePixel = 0
        pathButton.Text = string.rep("  ", i - 1) .. "â–¸ " .. name
        pathButton.TextColor3 = Color3.fromRGB(255, 255, 255)
        pathButton.TextSize = 15
        pathButton.Font = Enum.Font.SourceSans
        pathButton.TextXAlignment = Enum.TextXAlignment.Left
        pathButton.LayoutOrder = i
        pathButton.Parent = pathScrollFrame
        local buttonCorner = Instance.new("UICorner")
        buttonCorner.CornerRadius = UDim.new(0, 6)
        buttonCorner.Parent = pathButton
        pathButton.MouseButton1Click:Connect(function()
            self:FilterByPath(i, obj)
            pathButton.BackgroundColor3 = Color3.fromRGB(0, 150, 255)
            wait(0.2)
            pathButton.BackgroundColor3 = Color3.fromRGB(65, 65, 65)
        end)
        pathButton.MouseEnter:Connect(function()
            pathButton.BackgroundColor3 = Color3.fromRGB(90, 90, 90)
        end)
        pathButton.MouseLeave:Connect(function()
            pathButton.BackgroundColor3 = Color3.fromRGB(65, 65, 65)
        end)
    end
    pathScrollFrame.CanvasSize = UDim2.new(0, 0, 0, #path * 31)
end

-- â˜… æ›´æ–° GUIï¼ˆé¸å–åˆ—è¡¨å« + å±•é–‹æŒ‰éˆ•ï¼‰
function ObjectSelector:UpdateGUI()
    local teleportToButton  = self.mainFrame:FindFirstChild("TeleportToButton")
    local teleportHereButton = self.mainFrame:FindFirstChild("TeleportHereButton")
    local listScrollFrame   = self.mainFrame:FindFirstChild("ListScrollFrame")

    -- æ›´æ–°å‚³é€æŒ‰éˆ•æ–‡å­—ï¼ˆé¡¯ç¤ºå¯¦éš›ä½œç”¨æ•¸é‡ï¼‰
    local activeObjs = self:GetActiveObjects()
    local soloCount = 0
    for _ in pairs(self.soloObjects) do soloCount = soloCount + 1 end

    if teleportToButton then
        local count = #activeObjs
        local suffix = soloCount > 0 and string.format(" [å–®ç¨:%d]", soloCount) or ""
        if self.isTeleporting then
            teleportToButton.Text = string.format("â¸ åœæ­¢è‡ªå‹•å‚³é€ (%d/%d)%s",
                self.currentTeleportIndex, count, suffix)
            teleportToButton.BackgroundColor3 = Color3.fromRGB(200, 100, 0)
        else
            teleportToButton.Text = string.format("ğŸš€ å‚³é€åˆ°ç‰©é«” (%d)%s", count, suffix)
            teleportToButton.BackgroundColor3 = Color3.fromRGB(0, 150, 255)
        end
    end
    if teleportHereButton then
        local count = #activeObjs
        local suffix = soloCount > 0 and string.format(" [å–®ç¨:%d]", soloCount) or ""
        teleportHereButton.Text = string.format("ğŸ“¦ å‚³é€ç‰©é«”åˆ°æˆ‘ (%d)%s", count, suffix)
    end

    if not listScrollFrame then return end

    -- æ¸…é™¤èˆŠåˆ—è¡¨é …ç›®ï¼ˆåªæ¸… Frame é¡å‹ï¼‰
    for _, child in ipairs(listScrollFrame:GetChildren()) do
        if child:IsA("Frame") then child:Destroy() end
    end

    -- â˜… æ¯å€‹ç‰©ä»¶å»ºä¸€å€‹ Frameï¼Œå³å´æ”¾ "+" æŒ‰éˆ•ï¼Œå±•é–‹å¾Œå‘å·¦å‡ºç¾å…©å€‹æŒ‰éˆ•
    local ITEM_H = 32  -- æ¯åˆ—é«˜åº¦
    for i, obj in ipairs(self.allSelectedObjects) do
        local isGreen = false
        for _, selected in ipairs(self.selectedObjects) do
            if selected == obj then isGreen = true; break end
        end
        local isSolo = self.soloObjects[obj] == true

        -- å¤–å±¤ Frameï¼ˆä½œç‚ºåˆ—è¡¨è¡Œï¼‰
        local rowFrame = Instance.new("Frame")
        rowFrame.Name = "Row_" .. i
        rowFrame.Size = UDim2.new(1, -12, 0, ITEM_H)
        rowFrame.BackgroundColor3 = isSolo
            and Color3.fromRGB(180, 100, 0)   -- å–®ç¨é¸å–ï¼šæ©˜è‰²èƒŒæ™¯
            or (isGreen and Color3.fromRGB(0, 100, 0) or Color3.fromRGB(60, 60, 60))
        rowFrame.BorderSizePixel = 0
        rowFrame.LayoutOrder = i
        rowFrame.ClipsDescendants = false
        rowFrame.Parent = listScrollFrame
        local rowCorner = Instance.new("UICorner")
        rowCorner.CornerRadius = UDim.new(0, 6)
        rowCorner.Parent = rowFrame

        -- ç‰©ä»¶åç¨±æ¨™ç±¤ï¼ˆä½”ä¸»é«”å¯¬åº¦ï¼Œå³å´ç•™çµ¦ + æŒ‰éˆ•ï¼‰
        local nameLabel = Instance.new("TextLabel")
        nameLabel.Name = "NameLabel"
        nameLabel.Size = UDim2.new(1, -36, 1, 0)
        nameLabel.Position = UDim2.new(0, 6, 0, 0)
        nameLabel.BackgroundTransparency = 1
        nameLabel.Text = (isSolo and "â˜… " or (isGreen and "ğŸŸ¢ " or "â¬œ ")) .. obj.Name
        nameLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
        nameLabel.TextSize = 14
        nameLabel.Font = Enum.Font.SourceSans
        nameLabel.TextXAlignment = Enum.TextXAlignment.Left
        nameLabel.TextTruncate = Enum.TextTruncate.AtEnd
        nameLabel.Parent = rowFrame

        -- â˜… "+" å±•é–‹æŒ‰éˆ•ï¼ˆå³å´ï¼‰
        local plusBtn = Instance.new("TextButton")
        plusBtn.Name = "PlusBtn"
        plusBtn.Size = UDim2.new(0, 28, 0, 26)
        plusBtn.Position = UDim2.new(1, -30, 0, 3)
        plusBtn.BackgroundColor3 = Color3.fromRGB(80, 80, 80)
        plusBtn.Text = "+"
        plusBtn.TextColor3 = Color3.fromRGB(200, 200, 200)
        plusBtn.TextSize = 18
        plusBtn.Font = Enum.Font.SourceSansBold
        plusBtn.ZIndex = 5
        plusBtn.Parent = rowFrame
        local plusCorner = Instance.new("UICorner")
        plusCorner.CornerRadius = UDim.new(0, 5)
        plusCorner.Parent = plusBtn

        -- â˜… å±•é–‹å®¹å™¨ï¼ˆé è¨­éš±è—ï¼ŒæŒ‰ + å¾Œé¡¯ç¤ºï¼Œå‘å·¦ä¼¸å‡ºï¼‰
        local expandFrame = Instance.new("Frame")
        expandFrame.Name = "ExpandFrame"
        expandFrame.Size = UDim2.new(0, 200, 0, 26)   -- å®¹ç´å…©å€‹æŒ‰éˆ•
        expandFrame.Position = UDim2.new(1, -232, 0, 3) -- åœ¨ + æŒ‰éˆ•å·¦å´
        expandFrame.BackgroundTransparency = 1
        expandFrame.Visible = false
        expandFrame.ZIndex = 10
        expandFrame.ClipsDescendants = false
        expandFrame.Parent = rowFrame

        -- â˜… æŒ‰éˆ•1ï¼šã€Œå–®ç¨é¸å–ã€/ ã€Œè§£é™¤å–®ç¨é¸å–ã€
        local soloBtn = Instance.new("TextButton")
        soloBtn.Name = "SoloBtn"
        soloBtn.Size = UDim2.new(0, 94, 1, 0)
        soloBtn.Position = UDim2.new(0, 0, 0, 0)
        soloBtn.BackgroundColor3 = isSolo
            and Color3.fromRGB(200, 100, 0)
            or  Color3.fromRGB(0, 130, 200)
        soloBtn.Text = isSolo and "è§£é™¤å–®ç¨é¸å–" or "å–®ç¨é¸å–"
        soloBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
        soloBtn.TextSize = 11
        soloBtn.Font = Enum.Font.SourceSansBold
        soloBtn.ZIndex = 11
        soloBtn.Parent = expandFrame
        local soloBtnCorner = Instance.new("UICorner")
        soloBtnCorner.CornerRadius = UDim.new(0, 5)
        soloBtnCorner.Parent = soloBtn

        -- â˜… æŒ‰éˆ•2ï¼šã€Œè§£é™¤é¸å–ã€
        local deselBtn = Instance.new("TextButton")
        deselBtn.Name = "DeselBtn"
        deselBtn.Size = UDim2.new(0, 86, 1, 0)
        deselBtn.Position = UDim2.new(0, 98, 0, 0)
        deselBtn.BackgroundColor3 = Color3.fromRGB(180, 40, 40)
        deselBtn.Text = "è§£é™¤é¸å–"
        deselBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
        deselBtn.TextSize = 11
        deselBtn.Font = Enum.Font.SourceSansBold
        deselBtn.ZIndex = 11
        deselBtn.Parent = expandFrame
        local deselBtnCorner = Instance.new("UICorner")
        deselBtnCorner.CornerRadius = UDim.new(0, 5)
        deselBtnCorner.Parent = deselBtn

        -- â˜… + æŒ‰éˆ•é»æ“Šï¼šåˆ‡æ›å±•é–‹ç‹€æ…‹
        local expanded = false
        plusBtn.MouseButton1Click:Connect(function()
            expanded = not expanded
            expandFrame.Visible = expanded
            plusBtn.Text = expanded and "âˆ’" or "+"
            plusBtn.BackgroundColor3 = expanded
                and Color3.fromRGB(120, 60, 0)
                or  Color3.fromRGB(80, 80, 80)
        end)

        -- â˜… å–®ç¨é¸å– / è§£é™¤å–®ç¨é¸å–
        soloBtn.MouseButton1Click:Connect(function()
            if self.soloObjects[obj] then
                -- è§£é™¤å–®ç¨é¸å–
                self.soloObjects[obj] = nil
            else
                -- åŠ å…¥å–®ç¨é¸å–
                self.soloObjects[obj] = true
            end
            self:UpdateGUI()
        end)

        -- â˜… è§£é™¤é¸å–ï¼ˆå¾ allSelectedObjects ç§»é™¤ï¼‰
        deselBtn.MouseButton1Click:Connect(function()
            self.soloObjects[obj] = nil

            -- å¾ç¶ è‰²æ¸…å–®ç§»é™¤
            for idx, sel in ipairs(self.selectedObjects) do
                if sel == obj then table.remove(self.selectedObjects, idx); break end
            end
            -- å¾è·¯å¾‘éæ¿¾æ¸…å–®ç§»é™¤
            for idx, sel in ipairs(self.pathFilteredObjects) do
                if sel == obj then table.remove(self.pathFilteredObjects, idx); break end
            end

            self:RemoveHighlight(obj)
            self:UpdateAllSelectedObjects()
            self:UpdateGUI()
        end)
    end

    -- æ›´æ–°æ»¾å‹•é«˜åº¦ï¼ˆæ¯åˆ—é«˜åº¦ + é–“è·3ï¼‰
    listScrollFrame.CanvasSize = UDim2.new(0, 0, 0, #self.allSelectedObjects * (ITEM_H + 3))
end

-- â˜… å‚³é€åˆ°ç‰©é«”ï¼ˆä½¿ç”¨ GetActiveObjectsï¼‰
function ObjectSelector:TeleportToObject()
    local activeObjs = self:GetActiveObjects()
    if #activeObjs == 0 then return end

    local character = player.Character
    if not character then return end
    local humanoidRootPart = character:FindFirstChild("HumanoidRootPart")
    if not humanoidRootPart then return end

    if not self.isTeleporting then
        self.isTeleporting = true
        self.currentTeleportIndex = 1
        spawn(function()
            while self.isTeleporting do
                local objs = self:GetActiveObjects()
                if #objs == 0 then break end
                if self.currentTeleportIndex > #objs then
                    self.currentTeleportIndex = 1
                end
                local targetObj = objs[self.currentTeleportIndex]
                if targetObj then
                    local targetPos
                    if targetObj:IsA("BasePart") then
                        targetPos = targetObj.Position + Vector3.new(0, 5, 0)
                    elseif targetObj:IsA("Model") then
                        local pp = targetObj.PrimaryPart or targetObj:FindFirstChildWhichIsA("BasePart")
                        if pp then targetPos = pp.Position + Vector3.new(0, 5, 0) end
                    end
                    if targetPos then
                        humanoidRootPart.CFrame = CFrame.new(targetPos)
                        self.currentTeleportIndex = self.currentTeleportIndex + 1
                        self:UpdateGUI()
                    end
                end
                wait(0.1)
            end
            self.isTeleporting = false
            self:UpdateGUI()
        end)
        local btn = self.mainFrame:FindFirstChild("TeleportToButton")
        if btn then
            btn.Text = "â¸ åœæ­¢è‡ªå‹•å‚³é€"
            btn.BackgroundColor3 = Color3.fromRGB(200, 100, 0)
        end
    else
        self.isTeleporting = false
        self.currentTeleportIndex = 1
        local btn = self.mainFrame:FindFirstChild("TeleportToButton")
        if btn then
            btn.Text = string.format("ğŸš€ å‚³é€åˆ°ç‰©é«” (1/%d)", #activeObjs)
            btn.BackgroundColor3 = Color3.fromRGB(0, 150, 255)
        end
    end
end

-- â˜… å‚³é€ç‰©é«”åˆ°ç©å®¶ï¼ˆä½¿ç”¨ GetActiveObjectsï¼‰
function ObjectSelector:TeleportObjectsHere()
    local activeObjs = self:GetActiveObjects()
    if #activeObjs == 0 then return end

    local character = player.Character
    if not character then return end
    local humanoidRootPart = character:FindFirstChild("HumanoidRootPart")
    if not humanoidRootPart then return end

    local playerPos = humanoidRootPart.Position
    local targetPos = playerPos + Vector3.new(0, 2, 5)

    for _, obj in ipairs(activeObjs) do
        if obj:IsA("BasePart") then
            obj.CFrame = CFrame.new(targetPos)
        elseif obj:IsA("Model") then
            if obj.PrimaryPart or obj:FindFirstChildWhichIsA("BasePart") then
                obj:MoveTo(targetPos)
            end
        end
    end
end

-- æ¸…é™¤æ‰€æœ‰é¸å–
function ObjectSelector:ClearAllSelections()
    for _, obj in ipairs(self.selectedObjects) do self:RemoveHighlight(obj) end
    self.selectedObjects = {}
    for _, obj in ipairs(self.pathFilteredObjects) do self:RemoveHighlight(obj) end
    self.pathFilteredObjects = {}
    self.allSelectedObjects = {}
    self.soloObjects = {}  -- â˜… ä¹Ÿæ¸…ç©ºå–®ç¨é¸å–
    self.currentTeleportIndex = 1
    self:UpdateGUI()
    local pathScrollFrame = self.mainFrame:FindFirstChild("PathScrollFrame")
    if pathScrollFrame then
        for _, child in ipairs(pathScrollFrame:GetChildren()) do
            if child:IsA("TextButton") then child:Destroy() end
        end
    end
end

-- è™•ç†è§¸æ§é¸å–
function ObjectSelector:HandleTouchSelection(input)
    if not self.isSelectionMode then return end
    local unitRay = camera:ScreenPointToRay(input.Position.X, input.Position.Y)
    local ray = Ray.new(unitRay.Origin, unitRay.Direction * 1000)
    local target = workspace:FindPartOnRay(ray, player.Character)
    if target then
        self:SelectObject(target)
        if not self.guiVisible then
            self.guiVisible = true
            self.mainFrame.Visible = true
        end
        if game:GetService("HapticService"):IsVibrationSupported(Enum.UserInputType.Gamepad1) then
            game:GetService("HapticService"):SetMotor(Enum.UserInputType.Gamepad1, Enum.VibrationMotor.Large, 0.5)
            wait(0.1)
            game:GetService("HapticService"):SetMotor(Enum.UserInputType.Gamepad1, Enum.VibrationMotor.Large, 0)
        end
    end
end

-- åˆå§‹åŒ–
function ObjectSelector:Initialize()
    self:InitializeGUI()

    local openButton = Instance.new("TextButton")
    openButton.Name = "OpenButton"
    openButton.Size = UDim2.new(0, 60, 0, 60)
    openButton.Position = UDim2.new(1, -70, 0, 10)
    openButton.BackgroundColor3 = Color3.fromRGB(0, 200, 0)
    openButton.Text = "ğŸ¯"
    openButton.TextSize = 32
    openButton.Font = Enum.Font.SourceSansBold
    openButton.ZIndex = 10
    openButton.Parent = self.screenGui
    local openCorner = Instance.new("UICorner")
    openCorner.CornerRadius = UDim.new(0, 12)
    openCorner.Parent = openButton
    openButton.MouseButton1Click:Connect(function()
        self.guiVisible = not self.guiVisible
        self.mainFrame.Visible = self.guiVisible
        openButton:TweenSize(UDim2.new(0, 54, 0, 54), "Out", "Quad", 0.1, true, function()
            openButton:TweenSize(UDim2.new(0, 60, 0, 60), "Out", "Quad", 0.1, true)
        end)
    end)

    UserInputService.InputBegan:Connect(function(input, gameProcessed)
        if gameProcessed then return end
        if input.UserInputType == Enum.UserInputType.Touch or
           input.UserInputType == Enum.UserInputType.MouseButton1 then
            wait(0.05)
            if not self.isDragging then
                self:HandleTouchSelection(input)
            end
        end
    end)

    print("ğŸ¯ ç‰©é«”é¸å–å™¨å·²å•Ÿå‹•ï¼(å¹³æ¿è§¸æ§ç‰ˆ)")
    print("ğŸ“± é»æ“Šå³ä¸Šè§’ç¶ è‰²æŒ‰éˆ•é–‹å•Ÿç•Œé¢")
    print("ğŸ‘† è§¸æ§ç‰©é«”é€²è¡Œé¸å–ï¼ˆç¶ è‰²å¤–æ¡†ï¼‰")
    print("ğŸ“‚ é»æ“Šè·¯å¾‘å¯éæ¿¾ç›¸ä¼¼ç‰©é«”ï¼ˆç™½è‰²å¤–æ¡†ï¼‰")
    print("â˜…  é»æ“Šåˆ—è¡¨é …ç›®å³å´ + å¯å±•é–‹å–®ç¨é¸å–/è§£é™¤é¸å–æŒ‰éˆ•")
end

ObjectSelector:Initialize()
return ObjectSelector
